<!-- Order Management -->
@model GoodShoe.ViewModels.OrderManagementViewModel
@{
    ViewData["Title"] = "Order Management";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<link rel="stylesheet" href="~/css/admin.css" />

<div class="admin-container">
    <!-- Header -->
    <div class="admin-header">
        <h1 class="admin-title">
            <i class="fas fa-list-alt"></i>
            Order Status
        </h1>
        <div class="header-action back-button-container mb-4">
            <a href="@Url.Action("Index", "Admin")" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i> Back
            </a>
        </div>
    </div>
    
    <!-- Search and Filters -->
    <div class="admin-controls">
        <div class="search-container">
            <input type="text" id="orderSearch" placeholder="Search orders by email or ID ..." class="search-input">
            <i class="fas fa-search search-icon"></i>
        </div>
        <div class="filter-container">
            <select id="statusFilter" class="filter-select">
                <option value="">All Orders</option>
                <option value="Pending">Pending</option>
                <option value="Shipping">Shipping</option>
                <option value="Delivered">Delivered</option>
                <option value="Cancelled">Cancelled</option>
            </select>
        </div>
    </div>
    
    <!-- Success/Error Messages -->
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            @TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }
    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            @TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }
    
    <!-- Order Table-->
    <div class="table-container">
        <table class="admin-table" id="ordersTable">
            <thead>
            <tr>
                <th>Order ID</th>
                <th>Customer's Email</th>
                <th>Date</th>
                <th>Items</th> <!-- ADD this column -->
                <th>Total Cost</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
            </thead>
            <tbody>
            @if (Model.Orders != null && Model.Orders.Any())
            {
                @foreach (var order in Model.Orders)
                {
                    <tr class="order-row" data-status="@order.Status">
                        <td class="order-id">
                            <strong>@order.FormattedOrderId</strong>
                        </td>
                        <td class="buyer-email">
                            @order.CustomerEmail
                        </td>
                        <td class="order-date">
                            @order.FormattedDate
                            <br>
                            <small class="text-muted">@order.FormattedTime</small>
                        </td>
                        <td class="order-items"> <!-- ADD this cell -->
                            <span class="items-count">@order.Items</span>
                        </td>
                        <td class="order-total">
                            <span class="total-amount">@order.TotalAmount.ToString("C")</span>
                        </td>
                        <td class="order-status">
                            <span class="status-badge @order.StatusColor">@order.Status</span>
                        </td>
                        <td class="order-actions">
                            <div class="action-buttons">
                                <!-- View Order Details Button -->
                                <a href="@Url.Action("OrderDetails", "Order", new { id = order.OrderID })" 
                                   class="btn btn-sm btn-info">
                                    <i class="fas fa-eye"></i> View
                                </a>                                
                                <!--  Edit Status Button -->
                                <button type="button" class="btn btn-sm btn-primary"
                                        data-bs-toggle="modal"
                                        data-bs-target="#editStatusModal"
                                        data-order-id="@order.OrderID"
                                        data-current-status="@order.Status"
                                        data-order-number="@order.FormattedOrderId">
                                    <i class="fas fa-edit"></i> Edit
                                </button>

                                <!-- Delete Button -->
                                <button type="button" class="btn btn-sm btn-danger"
                                        data-bs-toggle="modal"
                                        data-bs-target="#deleteOrderModal"
                                        data-order-id="@order.OrderID"
                                        data-order-number="@order.FormattedOrderId">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                        </td>
                    </tr>
                }
            }
            else
            {
                <tr>
                    <td colspan="7" class="text-center py-4"> <!-- UPDATE colspan from 6 to 7 -->
                        <div class="empty-state">
                            <i class="fas fa-shopping-cart"></i>
                            <h3>No Orders Found</h3>
                            <p>Orders will appear here when customers make purchases.</p>
                        </div>
                    </td>
                </tr>
            }
            </tbody>
        </table>
    </div>
    <!-- Pagination -->
    @if (Model.TotalPages > 1)
    {
        <nav aria-label="Order pagination" class="mt-4">
            <ul class="admin-pagination justify-content-center">
                <!-- Previous Button -->
                <li class="admin-page-item @(Model.CurrentPage == 1 ? "disabled" : "")">
                    <a class="admin-page-link" href="@Url.Action("OrderList", new { page = Math.Max(1, Model.CurrentPage - 1) })" aria-label="Previous">
                        <i class="fas fa-chevron-left"></i>
                    </a>
                </li>
            
                <!-- Page Numbers -->
                @for (int i = Math.Max(1, Model.CurrentPage - 2); i <= Math.Min(Model.TotalPages, Model.CurrentPage + 2); i++)
                {
                    <li class="admin-page-item @(i == Model.CurrentPage ? "active" : "")">
                        <a class="admin-page-link" href="@Url.Action("OrderList", new { page = i })">@i</a>
                    </li>
                }
            
                <!-- Next Button -->
                <li class="admin-page-item @(Model.CurrentPage == Model.TotalPages ? "disabled" : "")">
                    <a class="admin-page-link" href="@Url.Action("OrderList", new { page = Model.CurrentPage + 1 })" aria-label="Next">
                        <i class="fas fa-chevron-right"></i>
                    </a>
                </li>
            </ul>
        </nav>
    }
    
    <!-- Summary -->
    <div class="table-summary">
        <p>Showing <strong>@Model.Orders.Count</strong> of <strong>@Model.TotalOrders</strong> orders (Page @Model.CurrentPage of @Model.TotalPages)</p>
    </div>
</div>

<!-- Edit Status Modal -->
<div class="modal fade" id="editStatusModal" tabindex="-1" aria-labelledby="editStatusModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editStatusModalLabel">Update Order Status</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" asp-action="UpdateOrderStatus">
                <div class="modal-body">
                    <input type="hidden" id="editOrderId" name="orderId" />
                    <div class="mb-3">
                        <label class="form-label">Order ID:</label>
                        <span id="editOrderNumber" class="fw-bold"></span>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Current Status:</label>
                        <span id="editCurrentStatus" class="badge"></span>
                    </div>
                    <div class="mb-3">
                        <label for="newStatus" class="form-label">New Status:</label>
                        <select class="form-select" id="newStatus" name="newStatus" required>
                            <option value="">Select Status</option>
                            <option value="Pending">Pending</option>
                            <option value="Shipping">Shipping</option>
                            <option value="Delivered">Delivered</option>
                            <option value="Cancelled">Cancelled</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Status</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Order Modal -->
<div class="modal fade" id="deleteOrderModal" tabindex="-1" aria-labelledby="deleteOrderModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteOrderModalLabel">Delete Order</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" asp-action="DeleteOrder">
                <div class="modal-body">
                    <input type="hidden" id="deleteOrderId" name="orderId" />
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>Warning!</strong> This action cannot be undone.
                    </div>
                    <p>Are you sure you want to delete order <strong id="deleteOrderNumber"></strong>?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">Delete Order</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="~/js/admin.js"></script>
<script>
    // Search functionality
    document.getElementById('orderSearch').addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        const rows = document.querySelectorAll('#ordersTable tbody tr');
        
        rows.forEach(row => {
            const orderId = row.querySelector('.order-id')?.textContent.toLowerCase() || '';
            const email = row.querySelector('.buyer-email')?.textContent.toLowerCase() || '';
            
            if (orderId.includes(searchTerm) || email.includes(searchTerm)) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    });

    // Status filter
    document.getElementById('statusFilter').addEventListener('change', function() {
        const selectedStatus = this.value;
        const rows = document.querySelectorAll('#ordersTable tbody tr');
        
        rows.forEach(row => {
            const status = row.getAttribute('data-status');
            
            if (selectedStatus === '' || status === selectedStatus) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    });

    // Edit status modal
    document.getElementById('editStatusModal').addEventListener('show.bs.modal', function(event) {
        const button = event.relatedTarget;
        const orderId = button.getAttribute('data-order-id');
        const currentStatus = button.getAttribute('data-current-status');
        const orderNumber = button.getAttribute('data-order-number');
        
        document.getElementById('editOrderId').value = orderId;
        document.getElementById('editOrderNumber').textContent = orderNumber;
        document.getElementById('editCurrentStatus').textContent = currentStatus;
        document.getElementById('editCurrentStatus').className = `badge status-${currentStatus.toLowerCase()}`;
        document.getElementById('newStatus').value = '';
    });

    // Delete order modal
    document.getElementById('deleteOrderModal').addEventListener('show.bs.modal', function(event) {
        const button = event.relatedTarget;
        const orderId = button.getAttribute('data-order-id');
        const orderNumber = button.getAttribute('data-order-number');
        
        document.getElementById('deleteOrderId').value = orderId;
        document.getElementById('deleteOrderNumber').textContent = orderNumber;
    });
</script>
