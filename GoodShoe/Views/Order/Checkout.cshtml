@model GoodShoe.ViewModels.CheckoutViewModel

@{ 
    ViewData["Title"] = "Checkout";
}

@section Scripts {
    <link rel="stylesheet" href="~/css/checkout.css" asp-append-version="true"/>
}

<div class="container-fluid px-4 py-3">
    <div class="row">
        <!-- Left Column - Delivery & Payment Forms -->
        <div class="col-lg-8">
            <form asp-action="Checkout" method="post">
                <!-- Delivery Section -->
                <div class="checkout-section mb-4">
                    <h3 class="checkout-section-title">Delivery</h3>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label asp-for="FirstName" class="form-label">First Name</label>
                            <input asp-for="FirstName" class="form-control" />
                            <span asp-validation-for="FirstName" class="text-danger"></span>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label asp-for="LastName" class="form-label">Last Name</label>
                            <input asp-for="LastName" class="form-control" />
                            <span asp-validation-for="LastName" class="text-danger"></span>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label asp-for="Address" class="form-label">Street Address & Postcode</label>
                        <input asp-for="Address" class="form-control" />
                        <span asp-validation-for="Address" class="text-danger"></span>
                    </div>
                    
                    <div class="mb-3">
                        <label asp-for="ContactNumber" class="form-label">Contact Number</label>
                        <input asp-for="ContactNumber" class="form-control" />
                        <span asp-validation-for="ContactNumber" class="text-danger"></span>
                    </div>
                </div>

                <!-- Payment Section -->
                <div class="checkout-section mb-4">
                    <h3 class="checkout-section-title">Payment</h3>
                    <p class="mb-3">How would you like to pay?</p>
                    
                    <!-- Payment Method Buttons -->
                    <div class="payment-methods mb-4">
                        <button type="button" class="payment-btn active" data-method="Credit / Debit Card">
                            Credit / Debit Card
                        </button>
                        <button type="button" class="payment-btn" data-method="Apple Pay">
                            Apple Pay
                        </button>
                        <button type="button" class="payment-btn" data-method="PayPal">
                            PayPal
                        </button>
                    </div>
                    
                    <input type="hidden" asp-for="PaymentMethod" />
                    
                    <!-- Payment Details Form -->
                    <div id="payment-details">
                        <h4 class="mb-3">Enter Your Payment Details</h4>
                        
                        <div class="mb-3">
                            <label asp-for="NameOnCard" class="form-label">Name on Card</label>
                            <input asp-for="NameOnCard" class="form-control" />
                        </div>
                        
                        <div class="mb-3">
                            <label asp-for="CardNumber" class="form-label">Card Number</label>
                            <input asp-for="CardNumber" class="form-control"
                                   maxlength="19" pattern="(\d{4}\s){3}\d{4}" inputmode="numeric" />
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="ExpiryDate" class="form-label">MM/YY</label>
                                <input asp-for="ExpiryDate" class="form-control" placeholder="MM/YY"
                                       pattern="(0[1-9]|1[0-2])\/\d{2}" />
                            </div>
                            <div class="col-md-6 mb-3">
                                <label asp-for="CVV" class="form-label">CVV</label>
                                <input asp-for="CVV" class="form-control"
                                       maxlength="3" pattern="\d{3}" inputmode="numeric" />
                            </div>
                        </div>
                    </div>
                    
                    <!-- Place Order Button -->
                    <button type="submit" class="btn btn-dark btn-lg w-100 mt-4 place-order-btn">
                        Place Order
                    </button>
                </div>
            </form>
        </div>
        
        <!-- Right Column - Order Summary -->
        <div class="col-lg-4">
            <div class="checkout-summary">
                <!-- Cart Items Preview -->
                <div class="cart-preview mt-4">
                    @foreach (var item in Model.CartItems)
                    {
                        <div class="cart-item-preview d-flex mb-3">
                            <img src="@item.ImageUrl" alt="@item.ProductName" class="preview-image me-3" />
                            <div class="item-details flex-grow-1">
                                <h6 class="mb-1">@item.ProductName</h6>
                                <p class="text-muted small mb-1">Men's Everyday Shoe</p>
                                <p class="text-muted small mb-0">Size: @item.Size</p>
                                <p class="text-muted small mb-0">Quantity: @item.Quantity</p>
                                <p class="fw-bold">@item.Price.ToString("C")</p>
                            </div>
                        </div>
                    }
                </div>

                <h4 class="mb-3">Summary</h4>

                <!-- summary with calculated totals from cart items -->
                <div class="summary-line">
                    <span>Subtotal (@Model.CartItems.Sum(i => i.Quantity) item@(Model.CartItems.Sum(i => i.Quantity) != 1 ? "s" : ""))</span>
                    <span>@Model.Subtotal.ToString("C")</span>
                </div>

                <div class="summary-line">
                    <span>Subtotal</span>
                    <span>@Model.Subtotal.ToString("C")</span>
                </div>

                <div class="summary-line">
                    <span>Estimated Delivery & Handling</span>
                    <span>@Model.DeliveryFee.ToString("C")</span>
                </div>

                <div class="summary-line total">
                    <strong>Total</strong>
                    <strong>@Model.Total.ToString("C")</strong>
                </div>

                <div class="delivery-info mt-3">
                    <p><strong>Estimate Delivery @Model.DeliveryDateRange</strong></p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // only numeric input for Contact Number
    const contactInput = document.querySelector('input[name="ContactNumber"]');
    if (contactInput) {
        contactInput.addEventListener('input', function () {
            this.value = this.value.replace(/\D/g, '').slice(0, 11);
        });
    }
    
    // Payment method selection
    document.querySelectorAll('.payment-btn').forEach(button => {
        button.addEventListener('click', function () {
            document.querySelectorAll('.payment-btn').forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
            const selectedMethod = this.getAttribute('data-method');
            document.querySelector('input[name="PaymentMethod"]').value = selectedMethod;
        });
    });

    // only numeric input for Card Number (max 12 digits)
    const cardNumberInput = document.querySelector('input[name="CardNumber"]');
    if (cardNumberInput) {
        cardNumberInput.addEventListener('input', function () {
            let digits = this.value.replace(/\D/g, '').slice(0, 16); // Max 16 digits
            this.value = digits.replace(/(.{4})/g, '$1 ').trim(); // Format: 1234 5678 9012 3456
        });
    }

    // only numeric input for CVV (max 3 digits)
    const cvvInput = document.querySelector('input[name="CVV"]');
    if (cvvInput) {
        cvvInput.addEventListener('input', function () {
            this.value = this.value.replace(/\D/g, '').slice(0, 3);
        });
    }

    // card expiry date MM/YY and auto show slash '/'
    const expiryInput = document.querySelector('input[name="ExpiryDate"]');
    if (expiryInput) {
        expiryInput.addEventListener('input', function () {
            let value = this.value.replace(/\D/g, '');

            if (value.length > 2) {
                value = value.slice(0, 2) + '/' + value.slice(2, 4);
            }

            this.value = value.slice(0, 5); // Max length "MM/YY"
        });
    }
</script>